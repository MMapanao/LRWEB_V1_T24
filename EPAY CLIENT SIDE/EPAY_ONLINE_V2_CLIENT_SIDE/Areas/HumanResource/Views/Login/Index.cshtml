@{ 
    Layout = "~/Areas/HumanResource/Views/Shared/_LoginLayout.cshtml";
}
@using LRWEB_V1_CLIENT_SIDE_T24.Areas.HumanResource
<link rel="stylesheet" type="text/css" media="screen" href="~/Areas/HumanResource/Resources/css/login.css" />
 
@using (Html.BeginForm(null, null, FormMethod.Post, new { id = "__AjaxAntiForgeryForm" }))
{
    @Html.AntiForgeryToken()
}

<div class="container-fluid"
     style="background-color:#fff;
        width: 300px;
        height: auto;
        margin-left: calc(75vw);
        margin-top: 15vh;
        padding:20px;
        text-align:center;
        position: absolute;">
    <img src="@GlobalVariableClass.FolderName/Areas/HumanResource/Resources/Images/lrlogo.png" alt="lrlogo" style="width:calc(100% - 120px);padding-top:10px;">
    <div style="padding-top:30px">
        <p style="margin-top:20px;color:#4f2683">Loan Ranger Web</p>
        <p style="color:#4f2683;">............................................</p>
    </div>
    <form id="loginform">
        <div class="form-group" style="text-align:left;">
            <input type="text"
                   class="form-control"
                   name="txtinput"
                   placeholder="Email"
                   id="txtemail"
                   required
                   value="" />
        </div>
        <div class="form-group" style="text-align:left;">
            <input type="password" class="form-control"
                   name="txtinput" placeholder="Password"
                   id="txtpassword"
                   required
                   value="" />
        </div>
        <div style="padding-top:50px;">
            <a style="color:#4f2683;" href="#" onclick="showforgotpass()">Forgot Password?</a>
        </div>
        <div style="padding-top:10px;">
            <button class="btn" id="btnlogin" style="width:100%;background-color:#FAA634;" type="submit"><b style="color:white;">LOG IN</b></button>
        </div>
    </form>
    <form id="changepassword" hidden>
        <div class="form-group" style="text-align:left;">
            <input type="password" class="form-control"
                   name="txtinput" placeholder="New Password"
                   id="txtnewpassword"
                   pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{12,}"
                   title="Must contain at least one  number and one uppercase and lowercase letter, and at least 12 or more characters"
                   required />
        </div>
        <div class="form-group" style="text-align:left;">
            <input type="password" class="form-control"
                   name="txtinput" placeholder="Confirm Password"
                   id="txtconfirmpassword"
                   pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{12,}"
                   title="Must contain at least one  number and one uppercase and lowercase letter, and at least 12 or more characters"
                   required />
        </div>
        <div style="padding-top:50px;">
            <button class="btn" style="width:45%;background-color:#FAA634;" type="submit"><b style="color:white;">SUBMIT</b></button>
            <a onClick="location.reload();" class="btn" id="btncancel" style="width:45%;background-color:#FAA634;"><b style="color:white;">CANCEL</b></a>
        </div>
    </form>
    <form id="forgotpassword" hidden>
        <div class="form-group" style="text-align:center;color:#fff;">
            <p style="color:#4f2683;"><strong>LETS GET STARTED</strong></p>
            <p style="color:#4f2683;">A temporary password will be sent to the email address provided below</p>
        </div>
        <div class="form-group" style="text-align:left;padding-top:10px;">
            <input type="email" class="form-control"
                   name="txtinput" placeholder="Email address"
                   id="txtforgotemail"
                   required />
        </div>
        <div style="padding-top:40px;">
            <button class="btn" style="width:45%;background-color:#FAA634;" type="submit"><b style="color:white;">SUBMIT</b></button>
            <a onClick="location.reload();" class="btn" id="btncancel" style="width:45%;background-color:#FAA634;"><b style="color:white;">CANCEL</b></a>
        </div>
    </form>
    <form id="forgotchangepassword" hidden>
        <div class="form-group" style="text-align:left;">
            <input type="password" class="form-control"
                   name="txtinput" placeholder="New Password"
                   id="txtforgotnewpassword"
                   pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{12,}"
                   title="Must contain at least one  number and one uppercase and lowercase letter, and at least 12 or more characters"
                   required />
        </div>
        <div class="form-group" style="text-align:left;">
            <input type="password" class="form-control"
                   name="txtinput" placeholder="Confirm Password"
                   id="txtforgotconfirmpassword"
                   pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{12,}"
                   title="Must contain at least one  number and one uppercase and lowercase letter, and at least 12 or more characters"
                   required />
        </div>
        <div style="padding-top:50px;">
            <button class="btn" style="width:45%;background-color:#FAA634;" type="submit"><b style="color:white;">SUBMIT</b></button>
            <a onClick="location.reload();" class="btn" id="btncancel" style="width:45%;background-color:#FAA634;"><b style="color:white;">CANCEL</b></a>
        </div>
    </form>


</div>
 
<!-- particles.js container -->
<div id="particles-js"></div>

<!-- scripts -->
@*<script src="~/Areas/LRForms/Resources/3rdParty/js/particles.js"></script>*@
@*<script src="~/Areas/LRForms/Resources/3rdParty/js/app.js"></script>*@

<style>
    body{
        background-size: cover;
        overflow:hidden;
    }
    .leaves {
        height: 150px;
        width: 150px;
    }
        .form-group{
        margin-bottom:5px;
        color:#5e5e5e;

    }
</style>
<div id="htmlotp" style="display:none;">
    <div style="min-width:100%;padding:5px;">
        <table>
            <tbody>
                <tr>
                    <td>
                        <div class="input-group" style="min-width:100%;">
                            <label style="width:100%;color:#4f2683"><b>Password Reset</b></label>
                            <br />
                            <input class="form-control" id="txttemppassword" name="otp" placeholder="Enter password" maxlength="12" style="text-align:center;border-radius:1px;min-width:100%;" />
                        </div>

                    </td>
                </tr>
            </tbody>
        </table>
        <div style="padding-top:20px;">
            <label class="custom-control-label" for="txt30days" style="font-size:.8em;color:#4f2683;"><b>Please enter the temporary password sent to your email address.</b></label>
        </div>
    </div>
    @*<div style="min-width:100%;padding:5px;">
        <table>
            <tbody>
                <tr>
                    <td>
                        <div class="input-group" style="min-width:100%;">
                            <label style="width:100%;color:#4f2683"><b>One-Time Password</b></label>
                            <br />
                            <input class="form-control" id="txtotp" name="otp" placeholder="Enter 6 Digit Code" maxlength="6" style="text-align:center;border-radius:1px;min-width:100%;" />
                        </div>

                    </td>
                </tr>
            </tbody>
        </table>
        <div class="custom-control custom-checkbox">
            <input type="checkbox" class="custom-control-input" id="txt30days">
            <label class="custom-control-label" for="txt30days" style="font-size:.8em;color:#4f2683;"><b>Don't ask for OTP in the next 30 days</b></label>
        </div>
    </div>*@
</div>
@*<script src="@GlobalVariableClass.FolderName/Areas/HumanResource/Resources/js/login.js"></script>*@

<style>
    .ui-corner-all {
        border-radius: 0px;
        -moz-border-radius-bottomright: 0px;
        -moz-border-radius-bottomleft: 0px;
        -moz-border-radius-topright: 0px;
        -moz-border-radius-topleft: 0px;
    }
    .custom-control, [type='checkbox'], .custom-control-label {
        cursor: pointer;
    }
    
</style>
@section scripts{
    <script>
        $(document).ready(function () {

            $("#loginform").submit(function (e) {
                e.preventDefault();
                checklogin();
            })

            $("#changepassword").submit(function (e) {
                e.preventDefault();
                let unm = $("#txtemail").val();
                let newpass = $('#txtnewpassword').val();
                let confirmpass = $('#txtconfirmpassword').val();
                changepass(unm, newpass, confirmpass);
            })

            $("#forgotpassword").submit(function (e) {
                e.preventDefault();
                showtemppassword();
            })

            $("#forgotchangepassword").submit(function (e) {
                e.preventDefault();
                let unm = $("#txtforgotemail").val();
                let newpass = $('#txtforgotnewpassword').val();
                let confirmpass = $('#txtforgotconfirmpassword').val();
                changepass(unm, newpass, confirmpass);
            })
        });

        function checklogin() {
            let unm = $("#txtemail").val();
            let ups = $("#txtpassword").val();
            if (unm == "") {
                alert('Username/Email is Required!');
            } else if (ups == "") {
                alert('Password is Required!');
            } else {
                $.ajax({
                    url: FolderName + "/HumanResource/Login/checklogin",
                    dataType: "json",
                    type: "POST",
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify({ unm: unm, ups: ups }),
                    async: true,
                    processData: false,
                    cache: false,
                    success: function (data) {
                        if (data.message == "disabled") {
                            $.alert("Your Account is Disabled Please Contact Your Administrator");
                        } else if (data.message == "passwordFailed") {
                            $.alert("Wrong Password Attempts : " + data.attempt)
                        } else if (data.message == "exceedAttempt") {
                            $.alert("You have exceeded the maximum number of login attempts and will be disabled. Please Contact your Administrator")
                        } else if (data.message == "noAccount") {
                            $.alert("Failed to Login")
                        } else if (data.message == "wrongPassword") {
                            $.alert("Wrong Password")
                        } else if (data.message == "newPassword") {
                            $.alert("You need to change your default password")
                            $('#loginform').attr('hidden', 'true');
                            $('#changepassword').removeAttr('hidden');
                        } else if (data.message == "confirm") {
                            let unm = $("#txtemail").val();
                            let ups = $("#txtpassword").val();
                            awhdkawudjaw(unm, ups);
                        } else if (data.message == "noLogout") {
                            var input = confirm("You are Currently Login to another device. Do you want to Continue?");
                            if (input == true) {
                                let unm = $("#txtemail").val();
                                let ups = $("#txtpassword").val();
                                awhdkawudjaw(unm, ups);
                            }
                        }
                    }
                });
            }
        }
        function showforgotpass() {
            $('#loginform').attr('hidden', 'true');
            $('#forgotpassword').removeAttr('hidden');
        }
        function awhdkawudjaw(unm, ups) {

            if (unm == "") {
                alert('Username/Email is Required!');
            } else if (ups == "") {
                alert('Password is Required!');
            } else {
                var form = $('#__AjaxAntiForgeryForm');
                var aaff = $('input[name="__RequestVerificationToken"]', form).val();

                var jsonX = {
                    unm: unm, ups: ups
                };
                $.ajax({
                    url: FolderName + "/HumanResource/Login/awkfawidjawkdvnkl",
                    type: "POST",
                    data: { __RequestVerificationToken: aaff, jsonX: jsonX },
                    success: function (data) {

                        if (data == "1") {
                            otpView();
                        } else if (data == "SC1") {
                            window.location = FolderName + "/HumanResource/Manage/Index?content=EnrollEmployee";
                        } else {
                            alert(data);
                        }
                    }
                });
            }
        }
        var htmlotpval = $("#htmlotp").html();
        function showtemppassword() {
            let unm = $("#txtforgotemail").val();
            $.ajax({
                url: FolderName + "/HumanResource/Login/checkemail",
                dataType: "json",
                type: "POST",
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify({ unm: unm }),
                async: true,
                processData: false,
                cache: false,
                success: function (data) {
                    if (data.message == "confirm") {
                        var confirm = $.confirm({
                            title: '',
                            columnClass: "small",
                            content: htmlotpval,
                            type: 'light',
                            typeAnimated: true,
                            buttons: {
                                tryAgain: {
                                    text: 'Submit',
                                    btnClass: 'btn-orange',
                                    action: function () {
                                        let unm = $("#txtforgotemail").val();
                                        var temppassword = $("#txttemppassword").val();
                                        $.ajax({
                                            url: FolderName + "/HumanResource/Login/checkOTP",
                                            dataType: "json",
                                            type: "POST",
                                            contentType: 'application/json; charset=utf-8',
                                            data: JSON.stringify({ unm: unm, otp: temppassword }),
                                            async: true,
                                            processData: false,
                                            cache: false,
                                            success: function (data) {
                                                if (data.message == "valid") {
                                                    $('#forgotpassword').attr('hidden', 'true');
                                                    $('#forgotchangepassword').removeAttr('hidden');
                                                    $.alert('You may now reset your password.');
                                                    
                                                    confirm.close()
                                                } else {
                                                    $.alert(data.message);
                                                    
                                                }
                                            }
                                        })
                                        return false;
                                    }
                                },
                                Resend: {
                                    text: '',
                                    btnClass: 'btn-orange',
                                    action: function () {
                                        $.ajax({
                                            url: FolderName + "/HumanResource/Login/checkemail",
                                            dataType: "json",
                                            type: "POST",
                                            contentType: 'application/json; charset=utf-8',
                                            data: JSON.stringify({ unm: unm }),
                                            async: true,
                                            processData: false,
                                            cache: false,
                                            success: function (data) {
                                                if (data.message == "confirm") {
                                                    $.alert('Temporary password has been resent to your email address.');
                                                }
                                            }
                                        });
                                        return false;
                                    }
                                },
                                Cancel: {
                                    btnClass: 'btn-orange',
                                    action: function () { }
                                }
                            }
                        });
                    } else if (data.message == "noAccount") {
                        $.alert("Email does not exist.")
                    }
                }
            })

            $("#htmlotp").html("");
        }
        function changepass(unm, newpass, confirmpass) {

            if (newpass == confirmpass) {
                $.ajax({
                    url: FolderName + "/HumanResource/Login/changepass",
                    dataType: "json",
                    type: "POST",
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify({ unm: unm, newpass: newpass }),
                    async: true,
                    processData: false,
                    cache: false,
                    success: function (data) {
                        let unm = data.unm;
                        let ups = data.ups;
                        if (data.message == "passwordChanged") {
                            $.alert({
                                title: '',
                                content: "Password reset successfully.",
                                onClose: function () {
                                    awhdkawudjaw(unm, ups);
                                },
                            });
                        }
                        //} else if (data.message == "invalidPassword") {
                        //    $.alert("A new password should not be the same from the last 5 passwords changed")
                        //}
                    },
                    error: function (response) {
                        console.log(response.responseText);
                    }
                });
            } else {
                $.alert("Password Unmatched")
            }


        }
    </script>    
}